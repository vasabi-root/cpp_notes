# RAII. Smart ptrs
–î–ª—è:
- `new` `delete`
- `lock(mutex)` `unlock(mutex)`
- `open connection` `close connection`

## `unique_ptr`
–ü—Ä–æ—Å—Ç–µ–π—à–∏–π. –†–∞–Ω—å—à–µ —Å–ª–æ–∂–Ω–æ –±—ã–ª–æ —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å, –∏–±–æ –µ–≥–æ –Ω–µ–ª—å–∑—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ù–æ —Å [c++11] –ø–æ—è–≤–∏–ª–∞—Å—å –º—É–≤-—Å–µ–º–∞–Ω—Ç–∏–∫–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º—É–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.

## `shared_ptr`
–ò–º–µ–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–≤–æ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ. –≠—Ç–æ—Ç —Å—á—ë—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ 1 –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –∫–æ–ø–∏–∏, –∏ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è –Ω–∞ 1 –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ. –ï–≥–æ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å —Å—Ç–∞—Ç–∏–∫, –∏–±–æ —Ç–∞–∫ –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–æ–±—â–µ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `shared_ptr`. –ù–∞–º –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –±—Ä–æ–¥–∫–∞—Å—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö `shared_ptr` —Å –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º. –≠—Ç–æ –ø–æ—á—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è -- –∏–º–µ–Ω–Ω–æ –æ–Ω –Ω–∞–º –∏ –Ω—É–∂–µ–Ω.

–ù–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–æ —Å–ª—É—á–∞–µ–º:
```c++
int *p = new int(1);
shared_ptr sptr1(p);
shared_ptr sptr2(p); 
// –¥–∞–±–ª —Ñ—Ä–∏ üçüüçü
```
–ù—É—É—É—É. –í–æ–æ–±—â–µ, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –º—É–≤–∞—Ç—å (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–Ω—É–ª—è—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –æ—Ç–ø–æ—á–∫–æ–≤–∞–ª–∏—Å—å), –Ω–æ –∫–æ–º–∏—Ç–µ—Ç –ø–æ—á–µ–º—É-—Ç–æ —Ä–µ—à–∏–ª, —á—Ç–æ –ª—É—á—à–µ –Ω–µ —Ä–µ—à–∞—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É (—Ç–∞–∫-—Ç–æ shared_ptr —É—Å—Ç—Ä–æ–µ–Ω –∫—É–¥–∞ —Å–ª–æ–∂–Ω–µ–µ, –º–± —Ç–∞–º –∫–∞–∫–∏–µ-—Ç–æ –≤–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã –µ—Å—Ç—å, –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é).

–ï—Å—Ç—å –µ—â—ë –æ–¥–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: –º—ã –≤—ã–∑—ã–≤–∞–µ–º `new` 2 —Ä–∞–∑–∞. –≠—Ç–æ –Ω–µ—Ö–æ—Ä–æ—à–æ, –∏–±–æ –¥–æ–ª–≥–æ -- –Ω—É–∂–Ω—ã –∞–ª–ª–æ–∫–∞—Ç–æ—Ä—ã –∏ —à—Ç—É–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—ã —Å–∫—Ä—ã–ª–∞ –æ—Ç –Ω–∞—Å —è–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `new` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —É–∫–∞–∑–∞—Ç–µ–ª—è. –≠—Ç–∞ —à—Ç—É–∫–∞ -- —Ñ—É–Ω–∫—Ü–∏—è `make_shared`. –ù–æ —Å–Ω–∞—á–∞–ª–∞, `make_unique` (–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ `make_shared` –ø–æ—è–≤–∏–ª—Å—è –≤ c++11, –∞ `make_unique` -- –≤ c++14)
```c++
template <typename T, typename ...Args>
shared_ptr<T> make_unique(Args&&... args) {
    return shared_ptr<T>(new T(std::forward<Args>(args)...));
    // –º–æ–∂–Ω–æ –±–µ–∑ forward_if_noexcept, –∏–±–æ new –Ω–µ –∫–∏–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    // —Ç–æ—á–Ω–µ–µ, –µ—Å–ª–∏ –æ–Ω –∫–∏–Ω–µ—Ç, —Ç–æ –æ–Ω –æ–±—è–∑—É–µ—Ç—Å—è –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ç–æ, —á—Ç–æ –Ω–∞–≤—ã–¥–µ–ª—è–ª
}
```
–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ `shared_ptr`. –°—Ä–∞–∑—É –∂–µ —Ä–µ—à–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `new` (–ø—Ä–∞–≤–¥–∞, –ø–æ–∫–∞ –∫–æ—Å—Ç—ã–ª—å–Ω–æ –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º)
```c++
template <typename T, typename ...Args>
shared_ptr<T> make_shared(Args&&... args) {
    void* p = ::operator new(sizeof(T) + sizeof(size_t)); // –ø—Ä–æ–±–ª–µ–º–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    new (p) T(std::forward<Args>(args)...);
    new (static_cast<T*>(p)+1) size_t();
    return shared_ptr<T>(new T(std::forward<Args>(args)...));
}
```
–õ—É—á—à–µ –æ–±–µ—Ä–Ω—É—Ç—å `T` –∏ `size_t` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏ –æ–ø–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–µ–π -- –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π –∏ —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º.

–ï—Å—Ç—å –µ—â—ë –æ–¥–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ -- —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ `T`:
```c++
T *root = new T();
T *child = new T();
root->next = child;
child->prev = root;

auto root = make_shared<T>();
auto child = make_shared<T>();
root->next = child;
child->prev = root;
```
–î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏–¥—É–º–∞–ª–∏ `weak_ptr`. 
### `weak_ptr`
–ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç. –î–æ–ø—É—Å–∫–∞–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.

–§–∏—à–∫–∞ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –æ–¥–Ω—É –∏–∑ "—Å—Ç–æ—Ä–æ–Ω" —É–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å–¥–µ–ª–∞—Ç—å `weak_ptr` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ next -- —ç—Ç–æ weak_ptr). –¢–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –µ—â—ë —Å—á—ë—Ç—á–∏–∫ –≤–∏–∫_–ø—Ç—Ä'–æ–≤. –ü—Ä–∏ —ç—Ç–æ–º –≤—ã–∑–æ–≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –≤–∏–∫, –∞ –¥–µ–∞–ª–ª–æ–∫–∞—Ü–∏—è -- –≤ —à—ç–π—Ä–¥.

## `enable_shared_from_this`
–ò–Ω–æ–≥–¥–∞ —Ö–æ—á–µ—Ü–∞ —Ç–∞–∫–æ–≥–æ:
```c++
struct Node {
  Node *next;

  shared_ptr<Node> get_shared() {
    return this; // –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–∞–±–ª —Ñ—Ä–∏ üçüüçü
  }
}
```
–†–µ—à–µ–Ω–∏–µ —Å—É–ø–µ—Ä-–Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ: –æ—Ç–Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç –∫–ª–∞—Å—Å–∞ `enable_shared_from_this` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö `shared_from_this`. `CRTP`
```c++
template <typename T>
struct Node: public std::enable_shared_from_this {
  Node *next;
  T object; 

  shared_ptr<Node<T>> get_shared() {
    return shared_from_this; // OK
  }
}
```
–î–æ–ø –ø—Ä–æ–±–ª–µ–º—ã –ø–æ –ø–æ–≤–æ–¥—É –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ [—Ç—É—Ç](https://youtu.be/9ZSBOfTd-sc?t=3943)

[–ø—Ä–æ 301 –±–∞–ª–ª –ø–æ—Ä–æ–≥–∞ –≤ –≤—É–∑–∞—Ö](https://youtu.be/xzK6Zx0TZx8?t=2790)