# RAII. Smart ptrs
–î–ª—è:
- `new` `delete`
- `lock(mutex)` `unlock(mutex)`
- `open connection` `close connection`

## `unique_ptr`
–ü—Ä–æ—Å—Ç–µ–π—à–∏–π. –†–∞–Ω—å—à–µ —Å–ª–æ–∂–Ω–æ –±—ã–ª–æ —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å, –∏–±–æ –µ–≥–æ –Ω–µ–ª—å–∑—è –∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å. –ù–æ —Å [c++11] –ø–æ—è–≤–∏–ª–∞—Å—å –º—É–≤-—Å–µ–º–∞–Ω—Ç–∏–∫–∞. –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ –º—É–≤–∞—Ç—å –≤–º–µ—Å—Ç–æ –∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∏—è.

## `shared_ptr`
–ò–º–µ–µ—Ç —Å—á—ë—Ç—á–∏–∫ —Å—Å—ã–ª–æ–∫ –Ω–∞ —Å–≤–æ—ë —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ. –≠—Ç–æ—Ç —Å—á—ë—Ç—á–∏–∫ –¥–æ–ª–∂–µ–Ω —É–≤–µ–ª–∏—á–∏–≤–∞—Ç—å—Å—è –Ω–∞ 1 –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ –∫–æ–ø–∏–∏, –∏ —É–º–µ–Ω—å—à–∞—Ç—å—Å—è –Ω–∞ 1 –≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–µ. –ï–≥–æ –Ω–µ–ª—å–∑—è –¥–µ–ª–∞—Ç—å —Å—Ç–∞—Ç–∏–∫, –∏–±–æ —Ç–∞–∫ –æ–Ω –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å –≤–æ–æ–±—â–µ –¥–ª—è –≤—Å–µ—Ö –æ–±—ä–µ–∫—Ç–æ–≤ `shared_ptr`. –ù–∞–º –Ω—É–∂–Ω–æ —á—Ç–æ-—Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å—Å—è –±—Ä–æ–¥–∫–∞—Å—Ç–æ–º –¥–ª—è –≤—Å–µ—Ö `shared_ptr` —Å –æ–¥–Ω–∏–º –∏ —Ç–µ–º –∂–µ —É–∫–∞–∑–∞—Ç–µ–ª–µ–º. –≠—Ç–æ –ø–æ—á—Ç–∏ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ —É–∫–∞–∑–∞—Ç–µ–ª—è -- –∏–º–µ–Ω–Ω–æ –æ–Ω –Ω–∞–º –∏ –Ω—É–∂–µ–Ω.

–ù–æ —á—Ç–æ –¥–µ–ª–∞—Ç—å —Å–æ —Å–ª—É—á–∞–µ–º:
```c++
int *p = new int(1);
shared_ptr sptr1(p);
shared_ptr sptr2(p); 
// –¥–∞–±–ª —Ñ—Ä–∏ üçüüçü
```
–ù—É—É—É—É. –í–æ–æ–±—â–µ, –º–æ–∂–Ω–æ –±—ã–ª–æ –±—ã –º—É–≤–∞—Ç—å (–∏–ª–∏ –ø—Ä–æ—Å—Ç–æ –∑–∞–Ω—É–ª—è—Ç—å —É–∫–∞–∑–∞—Ç–µ–ª—å, –æ—Ç –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –æ—Ç–ø–æ—á–∫–æ–≤–∞–ª–∏—Å—å), –Ω–æ –∫–æ–º–∏—Ç–µ—Ç –ø–æ—á–µ–º—É-—Ç–æ —Ä–µ—à–∏–ª, —á—Ç–æ –ª—É—á—à–µ –Ω–µ —Ä–µ—à–∞—Ç—å —ç—Ç—É –ø—Ä–æ–±–ª–µ–º—É (—Ç–∞–∫-—Ç–æ shared_ptr —É—Å—Ç—Ä–æ–µ–Ω –∫—É–¥–∞ —Å–ª–æ–∂–Ω–µ–µ, –º–± —Ç–∞–º –∫–∞–∫–∏–µ-—Ç–æ –≤–µ—Å–∫–∏–µ –ø—Ä–∏—á–∏–Ω—ã –µ—Å—Ç—å, –ø–æ–∫–∞ –Ω–µ –∑–Ω–∞—é).

–ï—Å—Ç—å –µ—â—ë –æ–¥–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞: –º—ã –≤—ã–∑—ã–≤–∞–µ–º `new` 2 —Ä–∞–∑–∞. –≠—Ç–æ –Ω–µ—Ö–æ—Ä–æ—à–æ, –∏–±–æ –¥–æ–ª–≥–æ -- –Ω—É–∂–Ω—ã –∞–ª–ª–æ–∫–∞—Ç–æ—Ä—ã –∏ —à—Ç—É–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –±—ã —Å–∫—Ä—ã–ª–∞ –æ—Ç –Ω–∞—Å —è–≤–Ω–æ–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ `new` –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ —É–∫–∞–∑–∞—Ç–µ–ª—è. –≠—Ç–∞ —à—Ç—É–∫–∞ -- —Ñ—É–Ω–∫—Ü–∏—è `make_shared`. –ù–æ —Å–Ω–∞—á–∞–ª–∞, `make_unique` (–∏–Ω—Ç–µ—Ä–µ—Å–Ω–æ, —á—Ç–æ `make_shared` –ø–æ—è–≤–∏–ª—Å—è –≤ c++11, –∞ `make_unique` -- –≤ c++14)
```c++
template <typename T, typename ...Args>
shared_ptr<T> make_unique(Args&&... args) {
    return shared_ptr<T>(new T(std::forward<Args>(args)...));
    // –º–æ–∂–Ω–æ –±–µ–∑ forward_if_noexcept, –∏–±–æ new –Ω–µ –∫–∏–¥–∞–µ—Ç –∏—Å–∫–ª—é—á–µ–Ω–∏–π
    // —Ç–æ—á–Ω–µ–µ, –µ—Å–ª–∏ –æ–Ω –∫–∏–Ω–µ—Ç, —Ç–æ –æ–Ω –æ–±—è–∑—É–µ—Ç—Å—è –æ—Å–≤–æ–±–æ–¥–∏—Ç—å —Ç–æ, —á—Ç–æ –Ω–∞–≤—ã–¥–µ–ª—è–ª
}
```
–¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –∏ `shared_ptr`. –°—Ä–∞–∑—É –∂–µ —Ä–µ—à–∞–µ–º –ø—Ä–æ–±–ª–µ–º—É –¥–≤–æ–π–Ω–æ–≥–æ –≤—ã–∑–æ–≤–∞ `new` (–ø—Ä–∞–≤–¥–∞, –ø–æ–∫–∞ –∫–æ—Å—Ç—ã–ª—å–Ω–æ –∏ –Ω–µ–ø–æ–Ω—è—Ç–Ω–æ, —á—Ç–æ —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º)
```c++
template <typename T, typename ...Args>
shared_ptr<T> make_shared(Args&&... args) {
    void* p = ::operator new(sizeof(T) + sizeof(size_t)); // –ø—Ä–æ–±–ª–µ–º–∞ –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏—è
    new (p) T(std::forward<Args>(args)...);
    new (static_cast<T*>(p)+1) size_t();
    return shared_ptr<T>(new T(std::forward<Args>(args)...));
}
```
–õ—É—á—à–µ –æ–±–µ—Ä–Ω—É—Ç—å `T` –∏ `size_t` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—É, –∏ –æ–ø–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Å –Ω–µ–π -- –±–µ–∑ –∫–æ—Å—Ç—ã–ª–µ–π –∏ —Å –≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º. –ù–æ —Ç–æ–≥–¥–∞ –ø—Ä–∏–¥—ë—Ç—Å—è —Ä–µ–∞–ª–∏–∑–æ–≤—ã–≤–∞—Ç—å —Ä–∞–∑–ª–∏—á–Ω—ã–µ —Å—Ü–µ–Ω–∞—Ä–∏–∏ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —à_–ø—Ç—Ä –æ—Ç —É–∫–∞–∑–∞—Ç–µ–ª—è –∏ –æ—Ç —Ü–±. –ò–±–æ –ø–∞–º—è—Ç—å –±—É–¥–µ—Ç –∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞–Ω–∞ –ø–æ-—Ä–∞–∑–Ω–æ–º—É. –î–æ–ø –ø—Ä–æ–±–ª–µ–º—ã –ø–æ –ø–æ–≤–æ–¥—É –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ [—Ç—É—Ç](https://youtu.be/9ZSBOfTd-sc?t=3943)

–¢–∞–∫–∂–µ –µ—Å—Ç—å —Å–º—ã—Å–ª –¥–µ–ª–∞—Ç—å –Ω–∞—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –≤ –≤–∏–¥–µ:
```c++
struct BaseControlBlock {
  size_t shared_count;
  size_t weak_count;
};

template <typename Deleter, typename Alloc>
struct ControlBlock {
  Deleter del;
  Alloc alloc;
}

template <typename T, typename Alloc> // Deleter –Ω–µ –Ω—É–∂–µ–Ω, —Ä–∞–∑ –º—ã —Å–∞–º–∏ –≤—ã–∑—ã–≤–∞–µ–º new
struct ControlBlockMakeShared: BaseControlBlock {
  T object;
  Alloc alloc;
};

```

–ï—Å—Ç—å –µ—â—ë –æ–¥–Ω–∞ –ø—Ä–æ–±–ª–µ–º–∞ -- —Ü–∏–∫–ª–∏—á–µ—Å–∫–∏–µ —Å—Å—ã–ª–∫–∏ –≤ `T`:
```c++
T *root = new T();
T *child = new T();
root->next = child;
child->prev = root;

auto root = make_shared<T>();
auto child = make_shared<T>();
root->next = child;
child->prev = root;
```
–î–ª—è —Ä–µ—à–µ–Ω–∏—è —ç—Ç–æ–π –ø—Ä–æ–±–ª–µ–º—ã –ø—Ä–∏–¥—É–º–∞–ª–∏ `weak_ptr`. 
### `weak_ptr`
–ü—Ä–æ—Å—Ç–æ –Ω–∞–±–ª—é–¥–∞–µ—Ç. –î–æ–ø—É—Å–∫–∞–µ—Ç —É–Ω–∏—á—Ç–æ–∂–µ–Ω–∏–µ –æ–±—ä–µ–∫—Ç–∞.

–§–∏—à–∫–∞ –≤ —Ç–æ–º, —á—Ç–æ–±—ã –æ–¥–Ω—É –∏–∑ "—Å—Ç–æ—Ä–æ–Ω" —É–∫–∞–∑–∞—Ç–µ–ª–µ–π —Å–¥–µ–ª–∞—Ç—å `weak_ptr` (–Ω–∞–ø—Ä–∏–º–µ—Ä, –≤—Å–µ next -- —ç—Ç–æ weak_ptr). –¢–æ–≥–¥–∞ –Ω—É–∂–Ω–æ –µ—â—ë —Å—á—ë—Ç—á–∏–∫ –≤–∏–∫_–ø—Ç—Ä'–æ–≤. –ü—Ä–∏ —ç—Ç–æ–º –≤—ã–∑–æ–≤ –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä–∞ –¥–æ–ª–∂–µ–Ω –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç—å –≤ –≤–∏–∫, –∞ –¥–µ–∞–ª–ª–æ–∫–∞—Ü–∏—è -- –≤ —à—ç–π—Ä–¥. –ö–æ–≥–¥–∞ `–≤–∏–∫_–∫–∞—É–Ω—Ç–µ—Ä` –æ–ø—É—Å—Ç–∏–ª—Å—è –¥–æ –Ω—É–ª—è, –Ω–∞–¥–æ –≤—ã–∑–≤–∞—Ç—å –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä, –∞ –∫–æ–≥–¥–∞ –æ–±–Ω—É–ª–∏–ª—Å—è `—à–µ–π—Ä–¥_–∫–∞—É–Ω—Ç–µ—Ä` -- –¥–µ–∞–ª–ª–æ—Ü–∏—Ä–æ–≤–∞—Ç—å.

## `enable_shared_from_this`
–ò–Ω–æ–≥–¥–∞ —Ö–æ—á–µ—Ü–∞ —Ç–∞–∫–æ–≥–æ:
```c++
struct Node {
  Node *next;

  shared_ptr<Node> get_shared() {
    return this; // –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ. –î–∞–±–ª —Ñ—Ä–∏ üçüüçü
  }
}
```
–†–µ—à–µ–Ω–∏–µ —Å—É–ø–µ—Ä-–Ω–µ–æ—á–µ–≤–∏–¥–Ω–æ–µ: –æ—Ç–Ω–∞—Å–ª–µ–¥–æ–≤–∞—Ç—å—Å—è –æ—Ç –∫–ª–∞—Å—Å–∞ `enable_shared_from_this` –∏ –≤–æ–∑–≤—Ä–∞—â–∞—Ç—å –≤ —Ç–∞–∫–∏—Ö —Å–ª—É—á–∞—è—Ö `shared_from_this`. `CRTP`
```c++
template <typename T>
struct Node: public std::enable_shared_from_this {
  Node *next;
  T object; 

  shared_ptr<Node<T>> get_shared() {
    return shared_from_this(); // OK
  }
}
```
–ö–∞–∫ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å `enable_shared_from_this`? 
```c++
template <typename T>
struct enable_shared_from_this {
  weak_ptr<T> wptr__;

  shared_ptr<T> shared_from_this() {
    if (wptr__.ptr == nullptr)
      throw 1;
    return wptr__.lock();
  }
}

template <typename T>
class shared_ptr {
  ...
public:
  shared_ptr(T* ptr): ptr_(ptr), count_(new size_t) {
    *count_ = 1;
    if constexpr (std::is_base_of_v<enable_shared_from_this<T>, T>) {
      wptr__ = *this;
    }
  }
};
```
–î–∞–ª—å—à–µ –±–æ–ª—å—à–µ -- shared_ptr –Ω–µ –∏–º–µ–µ—Ç –ø–æ–ª–µ–π –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞ –∏ –¥–µ–ª–∏—Ç–µ—Ä–∞!!! –ê –µ—â—ë, –∫–∞–∫ –ø—Ä–∏—Å–≤–∞–∏–≤–∞—Ç—å –¥–≤–∞ —à_–ø—Ç—Ä —Å —Ä–∞–∑–Ω—ã–º–∏ –∞–ª–ª–æ–∫–∞—Ç–æ—Ä–∞–º–∏/–¥–µ–ª–∏—Ç–µ—Ä–∞–º–∏?

# Type erasure
–Ø–∑—ã–∫ C++ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏ —Ç–∏–ø–∏–∑–∏—Ä–æ–≤–∞–Ω. –ü—Ä–∞–≤–¥–∞?
```c++
#include <any>
#include <vector>

int main {
  std::any a;
  a = 0;
  a = 0.3;
  a = "sdfsdf";
  a = std::vector<int>(3);
}
```
–ò –≤—Å—ë –∂–µ –¥–∞, –≤–µ–¥—å –µ—Å–ª–∏ –º—ã –∑–∞—Ö–æ—Ç–∏–º –æ–±—Ä–∞—Ç–∏—Ç—å—Å—è –∫ —Ö—Ä–∞–Ω–∏–º–æ–º—É —ç–ª–µ–º–µ–Ω—Ç—É, —Ç–æ –ø—Ä–∏–¥—ë—Ç—Å—è –¥–µ–ª–∞—Ç—å –∫–∞—Å—Ç:
```c++
  a = 0.5;
  cout << std::any_cast<double&>(a) << endl;
```
–ö–∞–∫ —Ç–∞–∫–æ–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å? –ù–∞–º –Ω—É–∂–Ω–æ –Ω–µ—á—Ç–æ, —á—Ç–æ –±—É–¥–µ—Ç –º–µ–Ω—è—Ç—å —Å–≤–æ—ë –ø–æ–≤–µ–¥–µ–Ω–∏–µ –≤ —Ä–∞–Ω—Ç–∞–π–º–µ. –≠—Ç–æ –ø–æ—Ö–æ–∂–µ –Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –Ω–æ —Ç–æ–ª—å–∫–æ –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –ø–æ–ª–µ–π:
```c++
struct any {
  struct Base {
    virtual Base* getCopy() const {}
    virtual ~Base() {} // –Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –Ω–æ —Ä–∞–∑ –µ—Å—Ç—å –æ–¥–Ω–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
                       // —Ç–æ –ª—É—á—à–µ –≤—Å—ë –∂–µ —Å–¥–µ–ª–∞—Ç—å –¥–µ—Å—Ç—Ä—É–∫—Ç–æ—Ä –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–º
  };

  template <typename T>
  struct Derived: Base {
    T object;
    Derived(const T& object): object(object) {}
    Derived(T&& object): object(std::move(object)) {}
    Base* getCopy() const override { return new Derived(object); }
  }

  Base* ptr;

  template<typename T>
  any(const T& obj): ptr(new Derived(obj)) {}
  any(const any& other): ptr(other.getCopy())  {}
  ~any() { delete ptr; }

  template <typename T>
  friend T any_cast(const &any a) {
    auto d = dynamic_cast<Derived<T>*>(a.ptr);
    if (!d) throw 1;
    return d.object;
  }
};



```



[–ø—Ä–æ 301 –±–∞–ª–ª –ø–æ—Ä–æ–≥–∞ –≤ –≤—É–∑–∞—Ö](https://youtu.be/xzK6Zx0TZx8?t=2790)